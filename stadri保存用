<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARTUP DREAMER - Official Edition</title>
    <style>
    /* 1. åŸºæœ¬è¨­å®š & ã‚«ãƒ©ãƒ¼å¤‰æ•° */
    :root { 
        --bg: #0a0b1e; --card: #161b33; --primary: #00f2ff; 
        --accent: #ff007a; --text: #ffffff; --gold: #ffd700; 
    }
    
    body { 
        font-family: sans-serif; background-color: var(--bg); color: var(--text); 
        margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; 
        display: flex; flex-direction: column; align-items: center;
    }

    /* 2. ç”»é¢ï¼ˆScreenï¼‰ã®å…±é€šè¨­å®šï¼šåŸºæœ¬ã¯éš ã™ */
    .screen { 
        display: none; /* åŸºæœ¬ã¯éè¡¨ç¤º */
        width: 95%; max-width: 800px; 
        background: var(--card); padding: 40px 20px; 
        border-radius: 20px; border: 2px solid var(--primary); 
        box-sizing: border-box; position: relative; margin: 20px auto;
        text-align: center;
    }

    /* 3. è¡¨ç¤ºä¸­ã®ç”»é¢ã ã‘ã‚’ä¸­å¤®å¯„ã›ã«ã™ã‚‹ (ã“ã“ãŒé‡è¦) */
    .screen.active,
    .screen[style*="display: block"],
    #title-screen.active { 
        display: flex !important; 
        flex-direction: column; 
        align-items: center; 
    }

    /* 4. ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢å°‚ç”¨ï¼ˆèƒŒæ™¯ãªã—ãƒ»ä¸­å¤®é…ç½®ï¼‰ */
    #title-screen { border: none; background: transparent; min-height: 80vh; justify-content: center; }
    .title-logo { 
        font-size: 4rem; font-weight: 900; color: var(--primary); 
        text-shadow: 0 0 15px var(--primary); line-height: 1.1; margin-bottom: 50px; 
    }

    /* 5. å…¨ä½“ã®æ–‡å­—ãƒ»ãƒœã‚¿ãƒ³ãƒ»å…¥åŠ›æ¬„ã‚’å·¨å¤§åŒ–ï¼ˆæ”¹è¡Œé˜²æ­¢ç‰ˆï¼‰ */
h2 { font-size: 2.8rem; color: var(--gold); margin-bottom: 25px; white-space: nowrap; }
h3 { font-size: 2rem; margin-bottom: 20px; }
p, li, label, div, span { font-size: 1.5rem; line-height: 1.5; }

.main-btn, .next-btn { 
    background: var(--primary); color: #000; border: none; 
    padding: 20px 30px; /* å·¦å³ã®ä½™ç™½ã‚’å°‘ã—èª¿æ•´ */
    border-radius: 50px; font-weight: bold; 
    font-size: 1.8rem; 
    
    /* æ”¹è¡Œã‚’çµ¶å¯¾ã«è¨±ã•ãªã„è¨­å®š */
    white-space: nowrap; 
    width: auto;           /* å›ºå®šå¹…ã‚’ã‚„ã‚ã‚‹ */
    min-width: 280px;      /* æœ€ä½é™ã®å¹…ã¯ç¢ºä¿ */
    max-width: 95%;        /* ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ */
    
    margin: 15px auto;
    display: flex;
    justify-content: center;
    align-items: center;
}

input[type="text"], input[type="number"], select { 
    background: #000; border: 1px solid var(--primary); color: white; 
    padding: 15px; border-radius: 10px; 
    width: 90%; max-width: 500px; 
    font-size: 1.8rem; text-align: center; margin: 15px 0;
}

    /* 6. ã‚¹ãƒ­ãƒƒãƒˆãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å·¨å¤§åŒ– */
    .slot-container { display: flex; justify-content: center; gap: 15px; margin: 25px 0; }
    .slot-reel-window { 
        width: 140px; height: 160px; overflow: hidden; 
        background: #fff; border: 5px solid var(--gold); border-radius: 10px; 
    }
    .slot-char { height: 160px; display: flex; align-items: center; justify-content: center; }
    .slot-char img { width: 130px; height: 130px; object-fit: contain; }

    #roulette-board { 
        width: 350px !important; height: 350px !important; 
        background: white; border: 10px solid var(--gold); border-radius: 50%; 
    }
    #g-info, #roulette-msg { font-size: 1.8rem; font-weight: bold; margin: 20px 0; }

    /* --- ãŠé¡Œç®±ï¼šã•ã‚‰ã«å·¨å¤§åŒ–ï¼†ã¯ã¿å‡ºã—é˜²æ­¢ --- */
    #odai-box {
        display: flex !important; 
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #000;
        min-height: 250px;    /* é«˜ã•ã‚’ã•ã‚‰ã«ã‚¢ãƒƒãƒ— */
        width: 100%;          /* ç”»é¢æ¨ªå¹…ã„ã£ã±ã„ã¾ã§è¨±å¯ */
        max-width: 750px;     /* æœ€å¤§å¹…ã‚’ã•ã‚‰ã«åºƒã’ã‚‹ */
        border: 6px solid var(--gold); /* æ ã‚‚å¤ªãã—ã¦å­˜åœ¨æ„Ÿã‚¢ãƒƒãƒ— */
        border-radius: 25px;
        margin: 20px auto;
        padding: 40px;        /* ä¸­ã®ä½™ç™½ã‚’åºƒã’ã‚‹ */
        cursor: pointer;
        text-align: center;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
        box-sizing: border-box; 
        overflow: hidden;     /* ã¯ã¿å‡ºã—ã‚’ã‚«ãƒƒãƒˆ */
    }

    #odai-text {
        font-size: 3rem !important; /* æ–‡å­—ã‚’ã•ã‚‰ã«å·¨å¤§åŒ– */
        font-weight: bold;
        color: #fff;
        margin: 0;
        
        /* é‡è¦ï¼šæ”¹è¡Œã‚’è¨±å¯ã—ã€æ¨ªã¸ã®ã¯ã¿å‡ºã—ã‚’é˜²ã */
        white-space: normal !important; 
        word-wrap: break-word !important; 
        overflow-wrap: break-word !important;
        line-height: 1.3;
        width: 100%;
    }

    #odai-box span {
        font-size: 1.4rem;
        color: var(--gold);
        margin-top: 20px;
    }

    /* 7. ãã®ä»–è¦ç´ ã®èª¿æ•´ */
    .rule-scroll { text-align: left; background: rgba(0,0,0,0.5); padding: 25px; border-radius: 15px; width: 100%; box-sizing: border-box; }
    ul { display: inline-block; text-align: left; }
    .investment-row { width: 100%; padding: 15px; font-size: 1.5rem; }
    .back-btn { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.1); padding: 10px 20px; font-size: 1rem; border-radius: 10px; }
    /* --- ã€Œãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã€ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒ”ãƒ³ã‚¯ã«ä¿®æ­£ --- */
    /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®2ç•ªç›®ã®ãƒœã‚¿ãƒ³ã‚„ã€accent-btnã‚¯ãƒ©ã‚¹ã‚’æŒã¤ã‚‚ã®ã‚’å¯¾è±¡ã«ã—ã¾ã™ */
    .accent-btn, 
    #title-screen .main-btn:nth-of-type(2) {
        background: var(--accent) !important;
        color: white !important;
    }
    /* --- ã‚¿ã‚¤ãƒãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ã®å¾©æ´»ã¨å¼·åŒ– --- */
.timer-display {
    font-size: 6rem !important; /* ã•ã‚‰ã«å·¨å¤§åŒ– */
    font-weight: 900;
    color: var(--primary);
    text-align: center;
    margin: 30px 0;
    font-family: 'Courier New', Courier, monospace; /* ãƒ‡ã‚¸ã‚¿ãƒ«æ„Ÿ */
    text-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary); /* å¼·çƒˆãªç™ºå…‰æ¼”å‡º */
    background: rgba(0, 0, 0, 0.3);
    padding: 20px 40px;
    border-radius: 20px;
    border: 3px solid var(--primary);
    box-shadow: inset 0 0 15px var(--primary);
    width: auto;
    display: inline-block;
}

/* æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªããªã£ãŸæ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆä»»æ„ã§JSã‹ã‚‰ã‚¯ãƒ©ã‚¹è¿½åŠ ç”¨ï¼‰ */
.timer-low {
    color: var(--accent) !important;
    text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent) !important;
    border-color: var(--accent) !important;
    box-shadow: inset 0 0 15px var(--accent) !important;
}
</style>
</head>
<body>
<div class="container">
    <div id="title-screen" class="screen active">
        <div class="title-logo">STARTUP<br>DREAMER</div>
        <button class="next-btn accent-btn" onclick="goTo('rule-screen')">ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª</button>
        <button class="next-btn" onclick="goTo('setup-screen')">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div id="rule-screen" class="screen">
    <button class="back-btn" onclick="goTo('title-screen')">â† ã‚¿ã‚¤ãƒˆãƒ«</button>
    <center>
        <h2 style="color:var(--primary); margin:10px 0 5px 0; font-size: 1.5rem;">STARTUP DREAMER</h2>
        <p style="color:var(--gold); font-size: 0.8rem; margin-bottom: 15px;">- OFFICIAL RULE BOOK -</p>
    </center>

    <div class="rule-scroll">
        <div class="rule-item">
            <h4>1. ã‚²ãƒ¼ãƒ ã®ç›®çš„</h4>
            <p>å…¨3ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æ™‚ã«ã€æœ€ã‚‚å¤šãã®<span class="highlight">ã€Œã‚¹ã‚¿ãƒ¼ã‚³ã‚¤ãƒ³ï¼ˆç·è³‡ç”£ï¼‰ã€</span>ã‚’ç¯‰ãä¸Šã’ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹è€…ã§ã™ã€‚</p>
        </div>

        <div class="rule-item">
            <h4>2. ãƒ©ã‚¦ãƒ³ãƒ‰ã®æµã‚Œ</h4>
            <ol style="padding-left: 20px; margin: 5px 0;">
                <li><strong>ã‚¢ã‚¤ãƒ‡ã‚¢è€ƒæ¡ˆ:</strong> ãŠæ‚©ã¿ã‚’è§£æ±ºã™ã‚‹æ¡ˆã‚’è€ƒãˆã¾ã™ï¼ˆç›®å®‰:3åˆ†ï¼‰ã€‚</li>
                <li><strong>ãƒ—ãƒ¬ã‚¼ãƒ³:</strong> ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ç†±ãä¼ãˆã¾ã™ï¼ˆç›®å®‰:1åˆ†ï¼‰ã€‚</li>
                <li><strong>æŠ•è³‡ã‚¿ã‚¤ãƒ :</strong> æœ‰æœ›ãªã‚¢ã‚¤ãƒ‡ã‚¢ã«ãƒãƒƒãƒ—ã‚’æŠ•ã˜ã¾ã™ã€‚</li>
                <li><strong>é‹å‘½ã®åˆ¤å®š:</strong> æ”¯æ´é¡ã«ã‚ˆã‚ŠæˆåŠŸç¢ºç‡ãŒæ±ºã¾ã‚Šã¾ã™ã€‚</li>
            </ol>
        </div>

        <div class="rule-item">
            <h4>3. æŠ•è³‡ã®ãƒ«ãƒ¼ãƒ«</h4>
            <p>ãƒ©ã‚¦ãƒ³ãƒ‰ãŒé€²ã‚€ã”ã¨ã«åˆè¨ˆæŠ•è³‡æ ãŒå¢—ãˆã¦ã„ãã¾ã™ã€‚</p>
            <ul style="padding-left: 20px; margin: 5px 0;">
                <li><span class="highlight">R1: åˆè¨ˆ3æš / R2: åˆè¨ˆ6æš / R3: åˆè¨ˆ9æš</span></li>
                <li>1äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æŠ•è³‡ã¯<span class="highlight">æœ€å¤§3æš</span>ã¾ã§ã€‚</li>
            </ul>
        </div>

        <div class="rule-item">
            <h4>4. æ”¯æ´é¡ã¨æˆåŠŸç¢ºç‡</h4>
            <table style="width:100%; border-collapse: collapse; font-size: 0.75rem; text-align: center; margin-top: 5px;">
                <tr style="background: rgba(0,242,255,0.2);">
                    <th style="border: 1px solid var(--primary); padding: 4px;">æ”¯æ´é¡</th>
                    <th style="border: 1px solid var(--primary); padding: 4px;">ç¢ºç‡</th>
                    <th style="border: 1px solid var(--primary); padding: 4px;">çŠ¶æ³</th>
                </tr>
                <tr><td style="border: 1px solid #333;">0æš</td><td style="border: 1px solid #333;">ç´„9%</td><td style="border: 1px solid #333; text-align: left;">å¥‡è·¡ã‚’ç¥ˆã‚‹</td></tr>
                <tr><td style="border: 1px solid #333;">1æš</td><td style="border: 1px solid #333;">ç´„52%</td><td style="border: 1px solid #333; text-align: left;">äº”åˆ†äº”åˆ†ã®å‹è² </td></tr>
                <tr><td style="border: 1px solid #333;">3æš</td><td style="border: 1px solid #333;">ç´„75%</td><td style="border: 1px solid #333; text-align: left;">æœ‰æœ›ãªäº‹æ¥­</td></tr>
                <tr><td style="border: 1px solid #333;">6æš</td><td style="border: 1px solid #333;">ç´„86%</td><td style="border: 1px solid #333; text-align: left;">ã‹ãªã‚Šå …å®Ÿ</td></tr>
                <tr><td style="border: 1px solid #333;">9æš</td><td style="border: 1px solid #333;">ç´„90%</td><td style="border: 1px solid #333; text-align: left;">å¸‚å ´ã®è¦‡è€…</td></tr>
            </table>
        </div>

        <div class="rule-item">
            <h4>5. å ±é…¬ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£</h4>
            <p><strong style="color:var(--primary);">ã€æˆåŠŸæ™‚ (SUCCESS!!)ã€‘</strong></p>
            <ul style="padding-left: 20px; margin: 5px 0;">
                <li><strong>ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¿ãƒ¼:</strong> æŠ•è³‡é¡ã®<span class="highlight">2å€</span>ã‚’ç²å¾—ã€‚æ”¯æ´0ãªã‚‰<span class="highlight">3æš</span>ç²å¾—ã€‚</li>
                <li><strong>æŠ•è³‡å®¶:</strong> æŠ•è³‡ã—ãŸé¡ãŒ<span class="highlight">3å€</span>ã«ãªã£ã¦æˆ»ã‚‹ã€‚</li>
            </ul>
            <p><strong style="color:var(--accent);">ã€å¤±æ•—æ™‚ (FAILURE...)ã€‘</strong></p>
            <p style="padding-left: 10px;">å…¨å“¡å ±é…¬ã‚¼ãƒ­ã€‚ãƒãƒƒãƒ—ã‚‚ã™ã¹ã¦æ²¡åã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <div class="rule-item">
            <h4>6. å€Ÿé‡‘ãƒªãƒã‚¤ãƒãƒ«</h4>
            <p>è³‡ç”£0ä»¥ä¸‹ã®æ™‚ã€ãƒ—ãƒ¬ã‚¼ãƒ³å‰ã«ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã™ã€‚</p>
            <table style="width:100%; border-collapse: collapse; font-size: 0.75rem; text-align: center; margin-top: 5px;">
                <tr style="background: rgba(255,0,122,0.2);">
                    <th style="border: 1px solid var(--accent); padding: 4px;">ãƒ¢ãƒ¼ãƒ‰</th>
                    <th style="border: 1px solid var(--accent); padding: 4px;">æˆåŠŸç‡</th>
                    <th style="border: 1px solid var(--accent); padding: 4px;">å ±é…¬</th>
                </tr>
                <tr><td style="border: 1px solid #333;">Highæ°´ã®é™£</td><td style="border: 1px solid #333;">åŠæ¸›</td><td style="border: 1px solid #333;">4å€</td></tr>
                <tr><td style="border: 1px solid #333;">è‹¦Lowã®é“</td><td style="border: 1px solid #333;">é€šå¸¸</td><td style="border: 1px solid #333;">2å€</td></tr>
            </table>
        </div>
    </div>
    <center><button class="main-btn" onclick="goTo('setup-screen')">è¨­å®šã¸é€²ã‚€</button></center>
</div>

    <div id="setup-screen" class="screen">
        <button class="back-btn" onclick="goTo('title-screen')">â† ã‚¿ã‚¤ãƒˆãƒ«</button>
        <h2 style="color:var(--primary); margin-top:20px; text-align:center;">âš™ï¸ ã‚²ãƒ¼ãƒ è¨­å®š</h2>
        <div style="margin-bottom:15px;">äººæ•°: <input type="number" id="num-players" value="4" min="2" max="6" oninput="generateInputs()" style="width:70px;"></div>
        <div id="name-area" style="margin-bottom:15px;"></div>
        <button class="next-btn accent-btn" style="max-width:none;" onclick="initGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
    </div>

    <div id="confirm-all-screen" class="screen">
        <button id="back-confirm" class="back-btn" onclick="confirmBack()">â† æˆ»ã‚‹</button>
        <h2 id="round-label-confirm" style="text-align:center; margin-top:20px;">ROUND 1</h2>
        <p style="text-align:center; color:var(--gold);">ã€ãŠé¡Œã®äº‹å‰ç¢ºèªã€‘é•·æŠ¼ã—ã§è¡¨ç¤º</p>
        <p style="text-align:center;"><strong id="confirm-name" style="color:var(--primary); font-size:1.5rem;"></strong> ã•ã‚“</p>
        <div id="odai-box" onmousedown="showOdai()" onmouseup="hideOdai()" ontouchstart="showOdai()" ontouchend="hideOdai()"></div>
        <button id="confirm-done-btn" class="next-btn" style="max-width:none;" onclick="nextConfirm()">ç¢ºèªã—ã¾ã—ãŸ</button>
    </div>

    <div id="thinking-screen" class="screen">
    <h2 style="text-align:center; color:var(--gold); margin-top:20px;">ğŸ’¡ Thinking Time</h2>
    
    <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 20px 0; width: 100%;">
        <button class="mode-btn" style="width:50px; height:50px; padding:0; font-size:1.5rem; display:flex; align-items:center; justify-content:center;" onclick="adjustTime(-30)">âˆ’</button>
        
        <div id="think-timer" class="timer-display" style="margin: 0; min-width: 150px; flex: none;">03:00</div>
        
        <button class="mode-btn" style="width:50px; height:50px; padding:0; font-size:1.5rem; display:flex; align-items:center; justify-content:center;" onclick="adjustTime(30)">+</button>
    </div>

    <center>
        <button class="main-btn" id="timer-toggle-btn" onclick="toggleTimer()" style="width:auto; padding: 10px 30px; margin-bottom:10px;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </center>
    <button class="next-btn accent-btn" style="max-width:none;" onclick="stopTimer(); db.pIdx=0; showPitch();">ãƒ—ãƒ¬ã‚¼ãƒ³ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div id="pitch-screen" class="screen">
        <button id="back-pitch" class="back-btn" onclick="pitchBack()">â† æˆ»ã‚‹</button>
        <h2 style="color:var(--accent); text-align:center; margin-top:20px;">ğŸ¤ ãƒ—ãƒ¬ã‚¼ãƒ³</h2>
        <p style="text-align:center;"><strong id="pitch-name" style="color:var(--primary); font-size:2rem;"></strong></p>
        <div id="revival-ui" style="display:none; border:2px solid var(--accent); padding:15px; border-radius:15px; margin-bottom:15px;">
            <p style="color:var(--accent); font-weight:bold; margin:0;">ğŸ“‰ å€Ÿé‡‘ãƒªãƒã‚¤ãƒãƒ«</p>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="m-low" class="mode-btn" onclick="setMode('Low')">è‹¦Low</button>
                <button id="m-high" class="mode-btn" onclick="setMode('High')">Highæ°´ã®é™£</button>
            </div>
        </div>
        <button id="pitch-done-btn" class="next-btn accent-btn" style="max-width:none;" onclick="nextPitch()">ãƒ—ãƒ¬ã‚¼ãƒ³çµ‚äº†</button>
    </div>

    <div id="invest-screen" class="screen">
        <button id="back-invest" class="back-btn" onclick="investBack()">â† æˆ»ã‚‹</button>
        <h2 style="text-align:center; margin-top:20px;">ğŸ’° æŠ•è³‡ã‚¿ã‚¤ãƒ </h2>
        <p id="inv-who" style="text-align:center; color:var(--gold); font-weight:bold;"></p>
        <p id="inv-limit-info" style="text-align:center; font-size:0.8rem;"></p>
        <div id="inv-list"></div>
        <button class="next-btn" style="max-width:none;" onclick="saveInv()">æŠ•è³‡ã‚’ç¢ºå®š</button>
    </div>

    <div id="gacha-screen" class="screen">
    <h2 id="g-name" style="text-align:center; color:var(--gold);"></h2>
    
    <div style="margin: 15px 0; background: #000; height: 25px; border-radius: 15px; border: 2px solid #333; position: relative; overflow: hidden;">
        <div id="g-rate-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary)); transition: width 0.5s;"></div>
        <div id="g-rate-text" style="position: absolute; width: 100%; text-align: center; line-height: 22px; font-weight: bold; font-size: 0.8rem;">æˆåŠŸç¢ºç‡: 0%</div>
    </div>

    <div id="slot-area" class="slot-container">
        <div class="slot-reel-window"><div id="reel-0" class="slot-reel"></div></div>
        <div class="slot-reel-window"><div id="reel-1" class="slot-reel"></div></div>
        <div class="slot-reel-window"><div id="reel-2" class="slot-reel"></div></div>
    </div>

    <div id="roulette-area" style="display:none; flex-direction:column; align-items:center; margin: 20px 0;">
    <div id="roulette-board" style="width: 280px; height: 280px; border-radius: 50%; border: 10px solid var(--gold); position: relative; background: radial-gradient(#fff, #f0f0f0); overflow: hidden; box-shadow: 0 0 25px rgba(0,0,0,0.3);">
        
        <div id="roulette-grid" style="position:absolute; width:100%; height:100%; opacity: 0.1;"></div>
        
        <div id="roulette-chars-container" style="position:absolute; width:100%; height:100%; z-index: 2;"></div>

        <div id="roulette-needle" style="position:absolute; top:0; left:calc(50% - 4px); width:8px; height:50%; background:#ff4d4d; transform-origin: bottom; border-radius: 10px; z-index:100; box-shadow: 0 0 5px rgba(0,0,0,0.2);">
            <div style="width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent; border-bottom:24px solid #ff4d4d; position:absolute; top:-20px; left:-8px;"></div>
        </div>

        <div style="position:absolute; top:50%; left:50%; width:30px; height:30px; background:var(--gold); border-radius:50%; transform:translate(-50%,-50%); z-index:101; border: 3px solid #fff;"></div>
    </div>
    <div id="roulette-msg" style="margin-top:15px; font-weight:bold; color:var(--gold); font-size:1.2rem; min-height: 1.5em;"></div>
</div>
    
    <div id="g-info" style="text-align:center; color:var(--primary); font-weight:bold; margin-bottom:20px; min-height: 3em;"></div>

    <center>
        <button class="main-btn accent-btn" id="roll-btn" onclick="roll()">é‹å‘½ã®åˆ¤å®šï¼</button>
        <button class="next-btn" id="next-g-btn" style="display:none;" onclick="nextG()">æ¬¡ã¸é€²ã‚€</button>
    </center>
</div>

    <div id="end-screen" class="screen">
        <h2 style="text-align:center; color:var(--gold);">ğŸ† çµæœç™ºè¡¨</h2>
        <div id="rank-list"></div>
        <button class="next-btn" style="max-width:none;" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>
</div>

<script>
const ODAIS = {
    "ãƒ•ã‚¡ãƒŸãƒªãƒ¼": ["å®¶äº‹ã‚„è‚²å…ãŒãƒ¯ãƒ³ã‚ªãƒšã«ãªã‚ŠãŒã¡","å­ã©ã‚‚ã®è‡ªä¸»æ€§ã®ä¼¸ã°ã—æ–¹ãŒã‚ã‹ã‚‰ãªã„","ç„¡é§„ãªå‡ºè²»ã‚’æ¸›ã‚‰ã—ãŸã„","é æ–¹ã®è¦ªã®è¦‹å®ˆã‚ŠãŒä¸ååˆ†","ç¿’ã„äº‹ã®é€ã‚Šè¿ãˆãŒå¤§å¤‰"],
    "ãƒ¤ãƒ³ã‚°ã‚¢ãƒ€ãƒ«ãƒˆ": ["æœ¬å½“ã«ã‚„ã‚ŠãŸã„ã“ã¨ãŒã‚ã‹ã‚‰ãªã„","æœ€åˆã®ä¸€æ­©ãŒè¸ã¿å‡ºã›ãªã„","SNSç–²ã‚Œãƒ»ã‚¹ãƒˆãƒ¬ã‚¹","ãŠé‡‘ãŒãªã„","éƒ½ä¼šã®ä¸€äººæš®ã‚‰ã—ã®å­¤ç‹¬"],
    "ãƒ“ã‚¸ãƒã‚¹å±¤": ["ãƒ©ãƒ³ãƒå¾Œã®çœ æ°—","æº€å“¡é›»è»Šã®ã‚¹ãƒˆãƒ¬ã‚¹","éƒ¨ä¸‹è‚²æˆã®æ‚©ã¿","å‡ºå¼µã®äºˆç´„ãƒˆãƒ©ãƒ–ãƒ«","è‡ªåˆ†ã«åˆã†ã‚¹ã‚­ãƒ«ãŒä¸æ˜"],
    "ã‚·ãƒ‹ã‚¢å±¤": ["å¥åº·ç¶­æŒã¸ã®ä¸å®‰","å­¤ç‹¬æ„Ÿãƒ»è©±ã—ç›¸æ‰‹ä¸è¶³","ãƒ‡ã‚¸ã‚¿ãƒ«ã®å£","è©æ¬ºã¸ã®ä¸å®‰","éºå“ç®¡ç†ã®å¿ƒé…"],
    "ãƒ¦ãƒ‹ãƒ¼ã‚¯": ["è¶³ã®ã‚€ãã¿","ãƒšãƒƒãƒˆã¨é•·æœŸå¤–å‡ºã—ãŸã„","æ–¹å‘éŸ³ç—´ã§è¿·ã†","æƒé™¤ãŒè‹¦æ‰‹ã§ç‰©ãŒæºœã¾ã‚‹","é‹å‹•ä¼šãŒæ†‚é¬±"]
};

let db = { players: [], curR: 1, pIdx: 0, invIdx: 0, invests: [], modes: [], invLog: [], playerOdai: [] };
let globalOdaiPool = [];
let timerObj = null;
let timeLeft = 180;

function goTo(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
}

function generateInputs() {
    const n = document.getElementById('num-players').value;
    const area = document.getElementById('name-area');
    area.innerHTML = "";
    for(let i=1; i<=n; i++) area.innerHTML += `<div style="margin-bottom:8px;"><input type="text" id="pn-${i}" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i} ã®åå‰"></div>`;
}
generateInputs();

function initGame() {
    const n = parseInt(document.getElementById('num-players').value);
    db.players = [];
    for(let i=1; i<=n; i++) {
        db.players.push({ id: i-1, name: document.getElementById(`pn-${i}`).value || `P${i}`, sc: 3, debt: 0 });
    }
    db.curR = 1;

    // --- ã“ã“ã‚’è¿½åŠ ï¼šãŠé¡Œã®å±±æœ­ï¼ˆãƒ—ãƒ¼ãƒ«ï¼‰ã‚’ä½œæˆ ---
    globalOdaiPool = [];
    Object.keys(ODAIS).forEach(cat => {
        ODAIS[cat].forEach(prob => {
            globalOdaiPool.push({cat, prob});
        });
    });
    // å±±æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    globalOdaiPool.sort(() => Math.random() - 0.5);

    startR();
}

function startR() {
    db.pIdx = 0;
    db.invests = new Array(db.players.length).fill(0);
    db.modes = new Array(db.players.length).fill('Low');
    db.invLog = [];
    db.playerOdai = [];

    db.players.forEach(p => {
        if(p.sc <= 0) p.debt += 1;

        // å±±æœ­ãŒç©ºã«ãªã£ãŸã‚‰å†è£œå……ï¼ˆäºˆå‚™ï¼‰
        if (globalOdaiPool.length === 0) {
            Object.keys(ODAIS).forEach(cat => {
                ODAIS[cat].forEach(prob => globalOdaiPool.push({cat, prob}));
            });
            globalOdaiPool.sort(() => Math.random() - 0.5);
        }
        
        // å±±æœ­ã‹ã‚‰1æšæŠœãå–ã‚‹ï¼ˆã“ã‚Œã§è¢«ã‚Šãªã—ï¼ï¼‰
        db.playerOdai.push(globalOdaiPool.pop());
    });
    showConfirm();
}

function showConfirm() {
    const p = db.players[db.pIdx];
    document.getElementById('round-label-confirm').innerText = `ROUND ${db.curR}`;
    document.getElementById('confirm-name').innerText = p.name;
    document.getElementById('odai-box').innerHTML = "";
    goTo('confirm-all-screen');
}

function nextConfirm() {
    if(db.pIdx < db.players.length - 1) { db.pIdx++; showConfirm(); }
    else { startThinking(); }
}

function confirmBack() {
    if(db.pIdx > 0) { db.pIdx--; showConfirm(); }
    else { goTo('setup-screen'); }
}

function adjustTime(amount) {
    let newTime = timeLeft + amount;
    
    // 180ç§’(3åˆ†)ã‚ˆã‚Šå°ã•ããªã‚‰ãšã€600ç§’(10åˆ†)ã‚ˆã‚Šå¤§ãããªã‚‰ãªã„ã‚ˆã†ã«åˆ¶é™
    if (newTime < 180) newTime = 180;
    if (newTime > 600) newTime = 600;
    
    timeLeft = newTime;
    updateTimerDisplay();
}

function startThinking() {
    // æ¯å›3åˆ†(180ç§’)ã«ãƒªã‚»ãƒƒãƒˆã—ãŸã„å ´åˆã¯ã“ã“ã‚’ 180 ã«ã™ã‚‹
    // å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®æ®‹ã‚Šæ™‚é–“ã‚’å¼•ãç¶™ããŸã„ãªã‚‰ã€ã“ã®è¡Œã‚’æ¶ˆã™
    timeLeft = 180; 
    
    updateTimerDisplay();
    document.getElementById('timer-toggle-btn').innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
    goTo('thinking-screen');
}

function toggleTimer() {
    if (timerObj) { stopTimer(); document.getElementById('timer-toggle-btn').innerText = "å†é–‹"; }
    else {
        document.getElementById('timer-toggle-btn').innerText = "ä¸€æ™‚åœæ­¢";
        timerObj = setInterval(() => {
            timeLeft--; updateTimerDisplay();
            if (timeLeft <= 0) { stopTimer(); alert("ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼"); }
        }, 1000);
    }
}

function stopTimer() { clearInterval(timerObj); timerObj = null; }

function updateTimerDisplay() {
    const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
    document.getElementById('think-timer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function showPitch() {
    const p = db.players[db.pIdx];
    document.getElementById('pitch-name').innerText = p.name;
    document.getElementById('revival-ui').style.display = (p.sc <= 0) ? 'block' : 'none';
    setMode('Low');
    goTo('pitch-screen');
}

function nextPitch() {
    if(db.pIdx < db.players.length - 1) { db.pIdx++; showPitch(); }
    else { db.invIdx = 0; showI(); }
}

function pitchBack() {
    if(db.pIdx > 0) { db.pIdx--; showPitch(); }
    else { startThinking(); }
}

function showI() {
    const inv = db.players[db.invIdx];
    if(inv.sc <= 0) { skipI(); return; }
    const walletLimit = db.curR * 3;
    document.getElementById('inv-who').innerText = `${inv.name} ã•ã‚“ã®æŠ•è³‡ (æ®‹:${inv.sc}æš)`;
    document.getElementById('inv-limit-info').innerText = `ä»ŠRæ : åˆè¨ˆ${walletLimit}æš / 1äººæœ€å¤§3æšã¾ã§`;
    let html = "";
    db.players.forEach((p, i) => { if(i !== db.invIdx) html += `<div class="investment-row"><span>${p.name} ã¸</span> <input type="number" class="iv" data-to="${i}" value="0" min="0" max="3" style="width:60px; background:#000; color:#fff; border:1px solid var(--primary); text-align:center;"></div>`; });
    document.getElementById('inv-list').innerHTML = html;
    goTo('invest-screen');
}

function saveInv() {
    const inv = db.players[db.invIdx];
    const inputs = document.querySelectorAll('.iv');
    const walletLimit = db.curR * 3;
    let sum = 0; inputs.forEach(i => sum += parseInt(i.value || 0));
    if(sum > walletLimit || sum > inv.sc) { alert("æŠ•è³‡æ ã¾ãŸã¯æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“"); return; }
    inputs.forEach(i => {
        let v = parseInt(i.value || 0); let to = parseInt(i.dataset.to);
        db.invests[to] += v;
        db.invLog.push({from:db.invIdx, to, amt:v});
        inv.sc -= v;
    });
    skipI();
}

function skipI() {
    db.invIdx++;
    // å…¨å“¡ã®æŠ•è³‡ãŒçµ‚ã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
    if(db.invIdx < db.players.length) {
        showI(); // æ¬¡ã®äººã®æŠ•è³‡ç”»é¢ã¸
    } else {
        db.pIdx = 0; // åˆ¤å®šã®ãŸã‚ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’0ã«æˆ»ã™
        showG(); // ã‚¹ãƒ­ãƒƒãƒˆï¼ˆåˆ¤å®šï¼‰ç”»é¢ã¸é€²ã‚€
    }
}

function investBack() {
    if(db.invIdx > 0) { db.invIdx--; showI(); }
    else { db.pIdx = db.players.length - 1; showPitch(); }
}

function showOdai() {
    const odai = db.playerOdai[db.pIdx];
    document.getElementById('odai-box').innerHTML = `<div style="color:var(--primary); font-size:0.9rem;">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼š${odai.cat}</div><div style="font-size:1.1rem; font-weight:bold;">${odai.prob}</div>`;
}
function hideOdai() { document.getElementById('odai-box').innerHTML = ""; }

function setMode(m) {
    db.modes[db.pIdx] = m;
    document.getElementById('m-low').className = (m === 'Low' ? 'mode-btn selected' : 'mode-btn');
    document.getElementById('m-high').className = (m === 'High' ? 'mode-btn selected' : 'mode-btn');
}

// â˜…â˜…â˜… ã“ã“ã«ä½¿ç”¨ã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®š â˜…â˜…â˜…
const URL_SUCCESS = "S__14319664.jpg"; // å³ã®ç·‘ã‚­ãƒ£ãƒ©ï¼ˆæˆåŠŸï¼‰
const URL_FAIL = "S__14319663.jpg";    // å·¦ã®èµ¤ã‚­ãƒ£ãƒ©ï¼ˆå¤±æ•—ï¼‰

function showG() {
    const p = db.players[db.pIdx];
    if (!db.round) db.round = 1;
    const currentRound = db.round;
    
    document.getElementById('g-name').innerText = `ã€Round ${currentRound}ã€‘ ${p.name}`;
    document.getElementById('g-info').innerText = `é›†ã¾ã£ãŸæ”¯æ´: ${db.invests[db.pIdx]} æš`;
    document.getElementById('roll-btn').style.display = "block";
    document.getElementById('next-g-btn').style.display = "none";
    
    // showG é–¢æ•°ã®ä¸­ã® currentRound === 2 ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã—ã¦ãã ã•ã„
if (currentRound === 2) {
    document.getElementById('slot-area').style.display = 'none';
    document.getElementById('roulette-area').style.display = 'flex';
    
    const container = document.getElementById('roulette-chars-container');
    container.innerHTML = "";
    
    // 1. ä»Šå›ã®æˆåŠŸç‡ã‚’è¨ˆç®—
    const successRate = ((db.invests[db.pIdx] + 0.1) / (db.invests[db.pIdx] + 1.1)) * (db.modes[db.pIdx] === 'High' ? 0.5 : 1.0);
    
    // â˜…ã“ã“ã«è¿½åŠ ã—ã¾ã™ï¼â˜…
    // 2. 12å€‹ã®ã†ã¡ã€ä½•å€‹ã‚’æˆåŠŸã‚­ãƒ£ãƒ©ã«ã™ã‚‹ã‹æ±ºå®š
    let winCount = Math.round(successRate * 12);
    if(winCount === 0 && successRate > 0) winCount = 1; // æœ€ä½1å€‹ã¯æˆåŠŸã‚’å…¥ã‚Œã‚‹
    if(winCount === 12) winCount = 11; // ã©ã‚“ãªã«é«˜ãã¦ã‚‚1å€‹ã¯å¤±æ•—ã‚’å…¥ã‚Œã‚‹

    // 3. æˆåŠŸãƒ»å¤±æ•—ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆwinCountã®æ•°ã ã‘trueã‚’å…¥ã‚Œã‚‹ï¼‰
    let spotList = [];
    for(let i = 0; i < 12; i++) {
        spotList.push(i < winCount); 
    }
    // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã€æˆåŠŸã¨å¤±æ•—ã‚’ãƒãƒ©ãƒãƒ©ã«ã™ã‚‹
    spotList.sort(() => Math.random() - 0.5);

    // 4. ãƒã‚¹ã‚’é…ç½®
    // showG é–¢æ•°å†…ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé…ç½®ãƒ«ãƒ¼ãƒ—
    spotList.forEach((isWin, i) => {
        const div = document.createElement('div');
        div.style.cssText = `position:absolute; width:100%; height:100%; transform:rotate(${i * 30}deg); text-align:center;`;
        div.innerHTML = `
            <img src="${isWin ? URL_SUCCESS : URL_FAIL}" 
                style="width:60px; height:60px; margin-top:15px; border-radius:50%; background:white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: 3px solid ${isWin ? '#4CAF50' : '#FF5252'};" 
                data-win="${isWin}">
        `; // ç”»åƒã‚µã‚¤ã‚ºã‚’ 45px -> 60px ã«ã‚¢ãƒƒãƒ—
        container.appendChild(div);
    });

    document.getElementById('roulette-msg').innerText = `æˆåŠŸãƒã‚¹: ${winCount} / 12`;
}
    else {
        document.getElementById('slot-area').style.display = 'flex';
        document.getElementById('roulette-area').style.display = 'none';
    }
    goTo('gacha-screen');
}

function roll() {
    const p = db.players[db.pIdx];
    const invAmt = db.invests[db.pIdx];
    const mode = db.modes[db.pIdx];
    const currentRound = db.round || 1;
    
    let probMult = (mode === 'High') ? 0.5 : 1.0;
    let successRate = ((invAmt + 0.1) / (invAmt + 1.1)) * probMult;
    
    document.getElementById('roll-btn').style.display = "none";
    const infoDisp = document.getElementById('g-info');

    // --- ç¬¬2ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡º ---
    if (currentRound === 2) {
        const needle = document.getElementById('roulette-needle');
        const spots = document.querySelectorAll('#roulette-chars-container div');
        
        // ç›¤é¢ã®ã‚­ãƒ£ãƒ©ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶ï¼ˆç¢ºç‡ã¯showGã§åæ˜ æ¸ˆã¿ï¼‰
        const winningIdx = Math.floor(Math.random() * spots.length);
        const winningSpot = spots[winningIdx];
        const isWinResult = winningSpot.querySelector('img').getAttribute('data-win') === "true";

        needle.style.transition = "none";
        needle.style.transform = "rotate(0deg)";

        setTimeout(() => {
            const spins = 3600; 
            const targetDeg = winningIdx * 30; // 12åˆ†å‰²ãªã®ã§30åº¦ãšã¤
            const totalDeg = spins + targetDeg;

            infoDisp.innerText = "é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ï¼";
            needle.style.transition = "transform 5s cubic-bezier(0.15, 0, 0.15, 1)";
            needle.style.transform = `rotate(${totalDeg}deg)`;

            setTimeout(() => finalizeGame(isWinResult), 5500);
        }, 100);

    } else {
        // --- ç¬¬1ãƒ»3ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šã‚¬ãƒã‚¹ãƒ­ãƒƒãƒˆæ¼”å‡ºï¼ˆæƒã†ã¾ã§ãƒ«ãƒ¼ãƒ—ï¼‰ ---
        const reels = [0, 1, 2].map(i => document.getElementById(`reel-${i}`));
        
        // ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒãƒ£ãƒ¼ã‚¸
        let count = 0;
        let chargeInterval = setInterval(() => {
            count += 2;
            if (count >= successRate * 100) {
                clearInterval(chargeInterval);
                startInfiniteSlot();
            } else {
                document.getElementById('g-rate-bar').style.width = count + "%";
                document.getElementById('g-rate-text').innerText = "æˆåŠŸç¢ºç‡: " + count + "%";
            }
        }, 20);

        async function startInfiniteSlot() {
            let results = [];
            infoDisp.innerText = "æŠ½é¸é–‹å§‹...";

            // å†…éƒ¨ã§1æšãšã¤æ­¢ã‚ã¦ã„ã
            for (let i = 0; i < 3; i++) {
                const isWinTick = Math.random() < successRate;
                const tickImg = isWinTick ? URL_SUCCESS : URL_FAIL;
                results.push(tickImg);

                // ãƒªãƒ¼ãƒ«ã®ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å›è»¢
                let html = "";
                for(let j=0; j<20; j++) {
                    html += `<div class="slot-char"><img src="${Math.random() < 0.5 ? URL_SUCCESS : URL_FAIL}"></div>`;
                }
                html += `<div class="slot-char"><img src="${tickImg}"></div>`;
                reels[i].innerHTML = html;
                reels[i].style.transition = "none";
                reels[i].style.transform = "translateY(0)";

                // startInfiniteSlot é–¢æ•°å†…ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†
        await new Promise(resolve => {
            let duration = 0.5;
            let delay = 700;
            if (i === 2 && results[0] === results[1]) {
                duration = 3.5;
                delay = 4000;
                infoDisp.innerText = "ãƒªãƒ¼ãƒï¼ï¼ï¼";
            }
            setTimeout(() => {
                reels[i].style.transition = `transform ${duration}s cubic-bezier(0.15, 0, 0.15, 1)`;
                // â˜… 120 ã‚’ 160 ã«å¤‰æ›´ï¼ˆCSSã§è¨­å®šã—ãŸ .slot-char ã®é«˜ã•ã«åˆã‚ã›ã‚‹ï¼‰
                const offset = (reels[i].children.length - 1) * 160; 
                reels[i].style.transform = `translateY(-${offset}px)`;
                setTimeout(resolve, delay);
            }, 50);
        });
            }

            // åˆ¤å®šï¼š3ã¤æƒã£ãŸã‹ï¼Ÿ
            if (results[0] === results[1] && results[1] === results[2]) {
                finalizeGame(results[0] === URL_SUCCESS);
            } else {
                infoDisp.innerText = "æƒã‚ãªã‹ã£ãŸï¼å†å§‹å‹•...";
                setTimeout(startInfiniteSlot, 1200); // æƒã†ã¾ã§ãƒ«ãƒ¼ãƒ—
            }
        }
    }

    // å…±é€šã®çµæœç¢ºå®šå‡¦ç†
    function finalizeGame(win) {
        if(!db.roundResults) db.roundResults = []; 
        db.roundResults[db.pIdx] = { win: win };
        if(win) {
            db.players[db.pIdx].sc += (invAmt === 0) ? 3 : invAmt * (mode === 'High' ? 4 : 2);
            db.invLog.filter(l => l.to == p.id).forEach(l => db.players[l.from].sc += l.amt * 3);
            infoDisp.innerText = "SUCCESS!!";
        } else {
            infoDisp.innerText = "FAIL...";
        }
        document.getElementById('next-g-btn').style.display = "block";
    }
}

function nextG() {
    db.pIdx++;
    if (db.pIdx < db.players.length) {
        showG(); // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
    } else {
        // å…¨å“¡çµ‚ã‚ã£ãŸã‚‰ã€roundãŒãªã‘ã‚Œã°1ã€ã‚ã‚Œã°+1
        if (!db.round) db.round = 1;
        db.round++; 
        showRoundLog(); // æŒ¯ã‚Šè¿”ã‚Šç”»é¢ã¸
    }
}

function showRank() {
    const sorted = [...db.players].sort((a,b) => (b.sc-b.debt) - (a.sc-a.debt));
    document.getElementById('rank-list').innerHTML = sorted.map((p,i) => {
        return `<div class="investment-row"><span>${i+1}ä½: <b>${p.name}</b></span><span class="highlight">${p.sc - p.debt}æš <small style="color:#aaa;">(è² å‚µ:${p.debt})</small></span></div>`;
    }).join('');
    goTo('end-screen');
}

// æŒ¯ã‚Šè¿”ã‚Šãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹æœ¬ä½“
function showRoundLog() {
    let html = "<h2>ROUND " + db.curR + " æŒ¯ã‚Šè¿”ã‚Š</h2>";
    db.players.forEach((p, i) => {
        const invAmt = db.invests[i];
        const mode = db.modes[i];
        const res = db.roundResults[i];
        
        // æˆåŠŸç‡ã®è¨ˆç®—ï¼ˆå…¬å¼ãƒ«ãƒ¼ãƒ«æº–æ‹  ï¼‰
        let probMult = (mode === 'High') ? 0.5 : 1.0;
        let rate = Math.round(((invAmt + 0.1) / (invAmt + 1.1)) * probMult * 100);
        let resText = res.win ? "<b style='color:#00f2ff;'>æˆåŠŸ</b>" : "<b style='color:#ff007a;'>å¤±æ•—</b>";

        html += `<div style="padding:10px; border-bottom:1px solid #444; text-align:left;">
            <strong>${p.name}</strong>: æŠ•è³‡${invAmt}æš (${rate}%) â” ${resText}
        </div>`;
    });

    // ç”»é¢ã«ãƒ­ã‚°ã‚’æµ®ã‹ã³ä¸ŠãŒã‚‰ã›ã‚‹æ¼”å‡º
    const logDiv = document.createElement('div');
    logDiv.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:#0a0b1e; z-index:9999; padding:20px; box-sizing:border-box; overflow-y:auto; text-align:center;";
    logDiv.innerHTML = html + `<button onclick="this.parentElement.remove(); finishLog();" class="next-btn" style="margin-top:20px;">æ¬¡ã¸é€²ã‚€</button>`;
    document.body.appendChild(logDiv);
}

// ãƒ­ã‚°ã‚’ç¢ºèªã—ãŸå¾Œã«æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆã¾ãŸã¯çµ‚äº†ï¼‰ã¸è¡Œãå‡¦ç†
function finishLog() {
    db.curR++;
    if(db.curR > 3) showRank();
    else startR();
}

</script>
</body>
</html>